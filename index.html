<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>4MFM RADIO • AO VIVO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="favicon.ico">

<style>
:root{
  --primary:#e10600;
  --glass:rgba(0,0,0,.55);
}

*{margin:0;padding:0;box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
body{background:#000;color:#fff;overflow:hidden}

#bgVideo,#bgImage{
  position:fixed;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
  filter:blur(7px) brightness(.55);
  z-index:-2;
}

.overlay{
  position:fixed;
  inset:0;
  background:linear-gradient(to top,rgba(0,0,0,.85),rgba(0,0,0,.25));
  z-index:-1;
}

header{
  display:flex;
  align-items:center;
  padding:16px 24px;
}
header img{width:80px}

.panel{
  position:absolute;
  bottom:40px;
  left:50%;
  transform:translateX(-50%);
  background:var(--glass);
  padding:18px 30px;
  border-radius:18px;
  text-align:center;
  min-width:320px;
  backdrop-filter:blur(12px);
}

.live{
  display:inline-block;
  background:var(--primary);
  padding:4px 14px;
  border-radius:20px;
  font-size:12px;
  animation:pulse 1.3s infinite;
}

@keyframes pulse{
  0%{opacity:1}
  50%{opacity:.45}
  100%{opacity:1}
}

.track{margin-top:10px;font-size:18px;font-weight:bold}
.artist{font-size:14px;opacity:.85}

button{
  margin-top:14px;
  padding:10px 30px;
  border:none;
  border-radius:30px;
  background:var(--primary);
  color:#fff;
  cursor:pointer;
  font-weight:bold;
}

.notice{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:var(--glass);
  padding:20px 34px;
  border-radius:20px;
}

.hidden{display:none}
</style>
</head>

<body>

<video id="bgVideo" muted playsinline></video>
<img id="bgImage">
<div class="overlay"></div>

<header>
  <img src="logo-4mfm.png" alt="4MFM">
</header>

<div class="notice" id="notice">
  Clique em <b>SINTONIZAR</b> para ouvir a rádio
</div>

<div class="panel">
  <div class="live">AO VIVO</div>
  <div class="track" id="track">—</div>
  <div class="artist" id="artist">—</div>
  <button id="start">Sintonizar</button>
</div>

<audio id="audio"></audio>

<script>
/* ================= CONFIG ================= */
const MUSIC_API="https://api.github.com/repos/BRAAR-ORG/4mfm-radio/releases/tags/musica";
const ANN_API="https://api.github.com/repos/BRAAR-ORG/4mfm-radio/releases/tags/announcer";
const SAVE_KEY="4mfm_state_v2";

const videos=[...Array(6)].map((_,i)=>`video${i+1}.mp4`);
const images=[...Array(037)].map((_,i)=>`img${String(i+1).padStart(3,'0')}.png`);

/* ================= STATE ================= */
let vIndex=0,iIndex=0,mode="video";
let music=[],announcer=[];
let started=false,restoring=false;

/* ================= ELEMENTS ================= */
const bgVideo=document.getElementById("bgVideo");
const bgImage=document.getElementById("bgImage");
const audio=document.getElementById("audio");

/* ================= HELPERS ================= */
const shuffle=a=>a.sort(()=>Math.random()-.5);

function formatName(name){
  return name.replace('.mp3','')
    .replace(/[._]+/g,' ')
    .replace(/\s+/g,' ')
    .trim()
    .replace(/\b(e|de|do|da|dos|das)\b/gi,m=>m.toLowerCase())
    .replace(/\b\w/g,l=>l.toUpperCase());
}

function split(name){
  const p=name.split(" - ");
  return p.length>1
    ?{artist:p[0],track:p.slice(1).join(" - ")}
    :{artist:"",track:name};
}

/* ================= MEDIA ================= */
function showMedia(){
  if(mode==="video"){
    bgImage.style.display="none";
    bgVideo.style.display="block";
    bgVideo.src=videos[vIndex];
    bgVideo.play();
  }else{
    bgVideo.pause();
    bgVideo.style.display="none";
    bgImage.style.display="block";
    bgImage.src=images[iIndex];
    setTimeout(nextMedia,8000);
  }
}

function nextMedia(){
  if(mode==="video"){
    vIndex++;
    if(vIndex>=videos.length){
      mode="image";
      iIndex=0;
    }
  }else{
    iIndex++;
    if(iIndex>=images.length){
      mode="video";
      vIndex=0;
    }
  }
  showMedia();
}

bgVideo.onended=nextMedia;

/* ================= CACHE ================= */
function saveState(isAnn){
  if(!audio.src) return;
  localStorage.setItem(SAVE_KEY,JSON.stringify({
    src:audio.src,
    time:audio.currentTime,
    isAnn,
    track:track.innerText,
    artist:artist.innerText
  }));
}

function restoreState(){
  const s=localStorage.getItem(SAVE_KEY);
  if(!s) return false;
  try{
    const d=JSON.parse(s);
    restoring=true;
    audio.src=d.src;
    audio.currentTime=d.time||0;
    track.innerText=d.track;
    artist.innerText=d.artist;
    audio.play().finally(()=>restoring=false);
    return true;
  }catch{return false;}
}

/* ================= AUDIO ================= */
async function loadAudio(){
  const m=await fetch(MUSIC_API).then(r=>r.json());
  const a=await fetch(ANN_API).then(r=>r.json());
  music=shuffle(m.assets.filter(x=>x.name.endsWith(".mp3")));
  announcer=shuffle(a.assets.filter(x=>x.name.endsWith(".mp3")));
}

function playAudio(){
  if(restoring) return;
  if(!music.length) return loadAudio().then(playAudio);

  const isAnn=Math.random()<0.2 && announcer.length;
  const src=isAnn?announcer.shift():music.shift();

  audio.src=src.browser_download_url;
  audio.currentTime=0;
  audio.play();

  if(isAnn){
    track.innerText="Mensagem da Rádio";
    artist.innerText="Kiara • 4MFM";
  }else{
    const info=split(formatName(src.name));
    track.innerText=info.track;
    artist.innerText=info.artist;
  }
}

audio.onended=playAudio;
setInterval(()=>saveState(artist.innerText.includes("Kiara")),2000);

/* ================= START ================= */
start.onclick=async()=>{
  if(started) return;
  started=true;
  notice.classList.add("hidden");
  await loadAudio();
  if(!restoreState()) playAudio();
  showMedia();
};
</script>

</body>
</html>
