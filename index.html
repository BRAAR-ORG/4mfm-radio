<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>4MFM Radio</title>

<link rel="icon" href="logo-4mfm.png">

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@300;500;700&display=swap" rel="stylesheet">

<style>
:root{
  --cyan:#00ffff;
  --bg:rgba(0,0,0,.55);
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:Inter,Arial,sans-serif;
  background:#000;
  color:#fff;
  overflow:hidden;
}

/* LOGO */
#radioLogo{
  position:fixed;
  top:18px;
  left:50%;
  transform:translateX(-50%);
  z-index:10;
  animation:logoFloat 6s ease-in-out infinite;
}
#radioLogo img{
  width:150px;
  filter:drop-shadow(0 0 15px var(--cyan));
}

/* BACKGROUND */
.bg-container{
  position:fixed;
  inset:0;
  z-index:-1;
  overflow:hidden;
}
.bg-container video,
.bg-container img{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
  opacity:0;
  transition:opacity 1.5s ease;
  filter:contrast(1.15) saturate(1.25) sepia(0.25) blur(3px);
}
.bg-container .active{
  opacity:1;
}

/* PLAYER */
#radioPlayer{
  position:fixed;
  bottom:22px;
  left:50%;
  transform:translateX(-50%);
  background:var(--bg);
  backdrop-filter:blur(10px);
  padding:22px 36px;
  border-radius:18px;
  border:1px solid rgba(0,255,255,.4);
  box-shadow:0 0 25px rgba(0,255,255,.35);
  text-align:center;
  animation:float 4s ease-in-out infinite;
}

#radioPlayer h1{
  margin:0;
  font-family:Orbitron;
  color:var(--cyan);
  font-size:22px;
}

#songName{
  margin-top:6px;
  font-weight:700;
  color:#ff4d4d;
  animation:pulse 1s infinite;
}

/* EQUALIZER */
.eq{margin-top:12px}
.eq span{
  display:inline-block;
  width:4px;
  height:10px;
  background:var(--cyan);
  margin:0 2px;
  animation:eq 0.6s infinite alternate;
}

/* MODAL */
#permissionModal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:999;
}
.modal-box{
  background:#111;
  padding:28px;
  border-radius:14px;
  text-align:center;
  max-width:360px;
}
button{
  margin-top:16px;
  padding:12px 26px;
  border:none;
  border-radius:8px;
  font-weight:bold;
  cursor:pointer;
  background:linear-gradient(90deg,#00ffff,#006bff);
  color:#000;
}

/* NOTIFY */
#notify{
  position:fixed;
  top:90px;
  left:50%;
  transform:translateX(-50%);
  background:#000;
  padding:10px 18px;
  border-radius:10px;
  color:var(--cyan);
  display:none;
  box-shadow:0 0 12px rgba(0,255,255,.4);
}

/* ANIMATIONS */
@keyframes eq{to{height:22px;opacity:1}}
@keyframes float{50%{transform:translateX(-50%) translateY(-6px)}}
@keyframes logoFloat{50%{transform:translateX(-50%) translateY(-8px)}}
@keyframes pulse{50%{transform:scale(1.15)}}
</style>
</head>

<body>

<div id="radioLogo">
  <img src="logo-4mfm.png">
</div>

<div id="notify"></div>

<!-- BACKGROUND (2 vídeos + imagens) -->
<div class="bg-container">
  <video src="video1.mp4" muted playsinline></video>
  <video src="video2.mp4" muted playsinline></video>

  <img src="img001.png">
  <img src="img002.png">
  <img src="img003.png">
  <img src="img004.png">
  <img src="img005.png">
  <img src="img006.png">
  <img src="img007.png">
  <img src="img008.png">
  <img src="img009.png">
  <img src="img010.png">
</div>

<div id="permissionModal">
  <div class="modal-box">
    <h2>Ativar Rádio</h2>
    <p>Toque para iniciar a 4MFM</p>
    <button id="allowBtn">OUVIR AGORA</button>
  </div>
</div>

<div id="radioPlayer">
  <h1>4MFM · AO VIVO</h1>
  <div id="songName">Carregando…</div>
  <div class="eq">
    <span></span><span></span><span></span><span></span><span></span>
  </div>
</div>

<audio id="player" playsinline></audio>

<script>
const player = document.getElementById("player");
const allowBtn = document.getElementById("allowBtn");
const modal = document.getElementById("permissionModal");
const songName = document.getElementById("songName");
const notify = document.getElementById("notify");
const bgItems = document.querySelectorAll(".bg-container video, .bg-container img");

player.volume = 1;

let playlist=[], announcers=[], playCount=0, bgIndex=0;

/* NOTIFICATION */
function notifyMsg(msg){
  notify.textContent = msg;
  notify.style.display = "block";
  setTimeout(()=>notify.style.display="none",3000);

  if("Notification" in window && Notification.permission==="granted"){
    new Notification("4MFM Radio",{body:msg,icon:"logo-4mfm.png"});
  }
}

/* BACKGROUND ROTATION */
function nextBackground(){
  bgItems.forEach(el=>{
    el.classList.remove("active");
    if(el.tagName==="VIDEO") el.pause();
  });

  const el = bgItems[bgIndex];
  el.classList.add("active");

  if(el.tagName==="VIDEO"){
    el.currentTime = 0;
    el.play();
    el.onended = ()=>{
      bgIndex = (bgIndex+1)%bgItems.length;
      nextBackground();
    };
  }else{
    setTimeout(()=>{
      bgIndex = (bgIndex+1)%bgItems.length;
      nextBackground();
    },8000);
  }
}

/* LOAD AUDIO */
async function loadData(){
  const songs = await fetch("https://api.github.com/repos/BRAAR-ORG/4mfm-radio/releases/tags/songs").then(r=>r.json());
  const ann = await fetch("https://api.github.com/repos/BRAAR-ORG/4mfm-radio/releases/tags/announcer").then(r=>r.json());

  playlist = (songs.assets||[]).filter(x=>x.name.endsWith(".mp3"));
  announcers = (ann.assets||[]).filter(x=>x.name.endsWith(".mp3"));
}

/* PLAY MUSIC */
async function playNext(){
  playCount++;
  let src,title;

  if((playCount%6===0||playCount%12===0)&&announcers.length){
    const a = announcers[Math.floor(Math.random()*announcers.length)];
    src = a.browser_download_url;
    title = "Kiara no Ar";
  }else{
    const m = playlist[Math.floor(Math.random()*playlist.length)];
    src = m.browser_download_url;
    title = m.name.replace(".mp3","").replace(/[.-]/g," ");
  }

  player.src = src;
  songName.textContent = title;
  notifyMsg("Tocando: "+title);
  await player.play();
}
player.onended = playNext;

/* IOS SAFE START */
allowBtn.onclick = async ()=>{
  modal.style.display="none";

  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  if(ctx.state==="suspended") await ctx.resume();

  notifyMsg("Conectando à 4MFM…");
  await loadData();
  await playNext();
  nextBackground();

  if("Notification" in window && Notification.permission!=="granted"){
    Notification.requestPermission();
  }
};
</script>

</body>
</html>
