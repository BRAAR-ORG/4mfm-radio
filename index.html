<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>4MFM RADIO • AO VIVO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" href="favicon.ico">

    <style>
        :root {
            --primary: #e10600;
            --primary-hover: #ff1a14;
            --glass: rgba(0, 0, 0, 0.65);
            --text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }

        body { 
            background: #000; 
            color: #fff; 
            overflow: hidden; 
            /* Fix para altura no iPhone (barra de endereço) */
            height: 100vh;
            height: 100dvh; 
            display: flex; 
            flex-direction: column; 
            -webkit-tap-highlight-color: transparent;
        }

        /* Background Layers */
        #bgVideo, #bgImage {
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: blur(8px) brightness(0.5);
            z-index: -2;
            transition: opacity 1s ease-in-out;
            display: none;
        }

        .overlay {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle, transparent 20%, rgba(0,0,0,0.8) 100%);
            z-index: -1;
            pointer-events: none;
        }

        /* UI Elements */
        header { padding: 20px 30px; position: relative; z-index: 10; }
        header img { width: 80px; filter: drop-shadow(var(--text-shadow)); }

        .notice {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--glass);
            padding: 20px 40px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            z-index: 5;
            transition: opacity 0.5s;
            white-space: nowrap;
        }

        .panel {
            position: absolute;
            bottom: 50px; /* Fallback */
            bottom: max(50px, env(safe-area-inset-bottom) + 20px); /* iPhone X+ Safe Area */
            left: 50%;
            transform: translateX(-50%);
            background: var(--glass);
            padding: 25px;
            border-radius: 24px;
            text-align: center;
            width: 90%;
            max-width: 400px;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .live-tag {
            background: var(--primary);
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: bold;
            letter-spacing: 1px;
            animation: pulse 2s infinite;
            display: inline-block;
            margin-bottom: 15px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.95); }
        }

        .track { font-size: 20px; font-weight: 700; margin-bottom: 4px; text-shadow: var(--text-shadow); }
        .artist { font-size: 15px; opacity: 0.8; margin-bottom: 20px; }

        button {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            background: var(--primary);
            color: #fff;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            /* Melhoria de toque no iOS */
            touch-action: manipulation;
        }

        button:active { transform: scale(0.96); }
        button:disabled { background: #444; cursor: default; opacity: 0.7; }

        .hidden { opacity: 0; pointer-events: none; }
    </style>
</head>

<body>

    <video id="bgVideo" muted playsinline autoplay loop></video>
    <img id="bgImage" alt="Background">
    <div class="overlay"></div>

    <header>
        <img src="logo-4mfm.png" onerror="this.style.display='none'" alt="4MFM">
    </header>

    <div class="notice" id="notice">
        Toque para <b>SINTONIZAR</b>
    </div>

    <main class="panel">
        <div class="live-tag">AO VIVO</div>
        <div class="track" id="track">Carregando...</div>
        <div class="artist" id="artist">4MFM RADIO</div>
        <button id="startBtn">Iniciar Rádio</button>
    </main>

    <audio id="audio" preload="auto"></audio>

<script>
/** * CONFIGURAÇÕES */
const CONFIG = {
    MUSIC_API: "https://api.github.com/repos/BRAAR-ORG/4mfm-radio/releases/tags/musica",
    ANN_API: "https://api.github.com/repos/BRAAR-ORG/4mfm-radio/releases/tags/announcer",
    VIDEOS: Array.from({length: 6}, (_, i) => `video${i + 1}.mp4`),
    IMAGES: Array.from({length: 25}, (_, i) => `img${String(i + 1).padStart(3, '0')}.png`),
    SAVE_KEY: "4mfm_radio_state",
    ANNOUNCER_INTERVAL: 6 * 60 * 1000,
    IMAGE_DURATION: 7000
};

/** * ESTADO */
const state = {
    mode: 'video',
    videoIdx: 0,
    imageIdx: 0,
    musicList: [],
    announcerList: [],
    lastAnnouncer: 0,
    isStarted: false,
    playlistReady: false
};

/** * ELEMENTOS */
const el = {
    video: document.getElementById("bgVideo"),
    image: document.getElementById("bgImage"),
    audio: document.getElementById("audio"),
    track: document.getElementById("track"),
    artist: document.getElementById("artist"),
    startBtn: document.getElementById("startBtn"),
    notice: document.getElementById("notice")
};

/** * UTILITÁRIOS */
const utils = {
    shuffle: (arr) => arr.sort(() => Math.random() - 0.5),
    
    formatName: (name) => {
        let clean = name.replace('.mp3', '').replace(/[._]+/g, ' ').trim();
        return clean.split(" - ");
    },

    updateMediaSession: (title, artist) => {
        if ('mediaSession' in navigator) {
            navigator.mediaSession.metadata = new MediaMetadata({
                title: title,
                artist: artist,
                album: "4MFM RADIO",
                artwork: [{ src: 'logo-4mfm.png', sizes: '512x512', type: 'image/png' }]
            });
            
            // Controles de Play/Pause na tela bloqueada
            navigator.mediaSession.setActionHandler('play', () => el.audio.play());
            navigator.mediaSession.setActionHandler('pause', () => el.audio.pause());
        }
    },

    save: () => {
        if (!el.audio.src || el.audio.paused) return;
        localStorage.setItem(CONFIG.SAVE_KEY, JSON.stringify({
            src: el.audio.src,
            time: el.audio.currentTime,
            title: el.track.innerText,
            artist: el.artist.innerText,
            lastAnn: state.lastAnnouncer,
            timestamp: Date.now() 
        }));
    }
};

/** * VISUAIS */
function updateVisuals() {
    // Tenta tocar vídeo silencioso (necessário interagir antes em alguns iOS)
    if(el.video.paused && state.mode === 'video') el.video.play().catch(() => {});

    if (state.mode === "video") {
        el.image.style.display = "none";
        el.video.style.display = "block";
        if(el.video.src.indexOf(CONFIG.VIDEOS[state.videoIdx]) === -1) {
             el.video.src = CONFIG.VIDEOS[state.videoIdx];
        }
    } else {
        el.video.style.display = "none";
        el.image.style.display = "block";
        el.image.src = CONFIG.IMAGES[state.imageIdx];
        setTimeout(nextVisual, CONFIG.IMAGE_DURATION);
    }
}

function nextVisual() {
    if (state.mode === "video") {
        state.videoIdx++;
        if (state.videoIdx >= CONFIG.VIDEOS.length) {
            state.mode = "image";
            state.imageIdx = 0;
            updateVisuals();
        } else {
            // Se ainda tem vídeo, carrega e toca
            el.video.src = CONFIG.VIDEOS[state.videoIdx];
            el.video.play().catch(() => nextVisual());
        }
    } else {
        state.imageIdx++;
        if (state.imageIdx >= CONFIG.IMAGES.length) {
            state.mode = "video";
            state.videoIdx = 0;
        }
        updateVisuals();
    }
}

el.video.onended = nextVisual;

/** * ÁUDIO */
async function initPlaylist() {
    try {
        const [mRes, aRes] = await Promise.all([
            fetch(CONFIG.MUSIC_API).then(r => r.json()),
            fetch(CONFIG.ANN_API).then(r => r.json())
        ]);
        
        state.musicList = utils.shuffle(mRes.assets.filter(v => v.name.endsWith('.mp3')));
        state.announcerList = utils.shuffle(aRes.assets.filter(v => v.name.endsWith('.mp3')));
        state.playlistReady = true;
        
        if(!state.isStarted) el.track.innerText = "Pronto para tocar";
    } catch (err) {
        el.track.innerText = "Erro de conexão";
        console.error(err);
    }
}

async function playNext() {
    if (state.musicList.length === 0 && !state.playlistReady) return;

    const now = Date.now();
    const shouldAnnounce = (now - state.lastAnnouncer) > CONFIG.ANNOUNCER_INTERVAL && Math.random() < 0.3;

    let currentItem;
    let title = "", artist = "";

    if (shouldAnnounce && state.announcerList.length > 0) {
        currentItem = state.announcerList.shift();
        state.announcerList.push(currentItem); // Recicla anunciante
        state.lastAnnouncer = now;
        title = "Mensagem da Rádio";
        artist = "Kiara";
    } else {
        if(state.musicList.length === 0) await initPlaylist(); // Recarrega se acabar
        currentItem = state.musicList.shift();
        const parts = utils.formatName(currentItem.name);
        artist = parts[0];
        title = parts[1] || "Hit 4MFM";
    }

    // Atualiza UI
    el.track.innerText = title;
    el.artist.innerText = artist;
    utils.updateMediaSession(title, artist);

    // Toca
    el.audio.src = currentItem.browser_download_url;
    el.audio.play().catch(e => console.log("Aguardando interação:", e));
}

el.audio.onended = playNext;
el.audio.onerror = () => setTimeout(playNext, 2000); // Pula se der erro

/** * CONTROLES */
el.startBtn.onclick = async () => {
    // 1. Desbloqueio imediato do AudioContext (CRUCIAL PARA IOS)
    el.audio.play().then(() => {
        el.audio.pause();
    }).catch(() => {});

    if (state.isStarted) return;
    
    state.isStarted = true;
    el.startBtn.disabled = true;
    el.startBtn.innerText = "Sintonizando...";
    el.notice.classList.add("hidden");

    // Tenta restaurar estado se for recente (< 1 hora)
    const saved = localStorage.getItem(CONFIG.SAVE_KEY);
    let restored = false;

    if (saved) {
        const d = JSON.parse(saved);
        // Só restaura se foi salvo há menos de 30 min
        if (Date.now() - (d.timestamp || 0) < 1800000) {
            el.audio.src = d.src;
            el.track.innerText = d.title;
            el.artist.innerText = d.artist;
            state.lastAnnouncer = d.lastAnn;
            
            // iOS precisa carregar metadados antes de pular tempo
            el.audio.onloadedmetadata = () => {
                el.audio.currentTime = d.time;
                el.audio.play();
                el.audio.onloadedmetadata = null; // Limpa listener
            };
            // Força load se metadata não vier
            el.audio.load();
            utils.updateMediaSession(d.title, d.artist);
            restored = true;
        }
    }

    if (!restored) {
        if (state.playlistReady) {
            playNext();
        } else {
            // Se clicou antes da playlist baixar
            await initPlaylist();
            playNext();
        }
    }

    // Inicia vídeo
    updateVisuals();
    el.startBtn.innerText = "Tocando Agora";
    
    // Auto-save
    setInterval(utils.save, 5000);
};

// Inicia download da lista imediatamente (não espera o clique)
initPlaylist();

</script>
</body>
</html>
